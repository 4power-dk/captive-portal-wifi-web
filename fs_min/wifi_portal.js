var WiFiPortal={SSIDs:[],Networks:[],_msg_proto:function(t){return{$el:document.getElementById(t),show:function(t){this.$el.innerHTML=t,this.$el.style.display="block"},hide:function(){this.$el.style.display="none"}}},init:function(){WiFiPortal.Buttons.init(),WiFiPortal.Info=new WiFiPortal._msg_proto("info"),WiFiPortal.Error=new WiFiPortal._msg_proto("error"),document.getElementById("networks").onchange=function(t){var e=this.value||this.options[this.selectedIndex].value;WiFiPortal.selectNetwork(e)},document.getElementById("networks").onblur=function(t){var e=this.value||this.options[this.selectedIndex].value;WiFiPortal.selectNetwork(e)},WiFiPortal.check(function(t){WiFiPortal.rescan()},!1)},check:function(o,r){WiFiPortal.Buttons.disableAll("Please wait, checking..."),WiFiPortal.rpcCall("GET","Sys.GetInfo",r||!1,!1,function(t){var e,i="Error";i=t&&!0!==t?(e=t.wifi||t,e=JSON.stringify(e,void 0,2),WiFiPortal.highlight(e)):"Unable to get info from device",document.getElementById("response").innerHTML=i||"",r||WiFiPortal.Buttons.enableAll(),"function"==typeof o&&o(t)})},Info:{},Error:{},Timers:{clear:function(){WiFiPortal.Timers.Test.remove(),WiFiPortal.Timers.Timeout.remove()},Timeout:{_id:!1,init:function(){WiFiPortal.Timers.Timeout.remove(),WiFiPortal.Timers.Timeout._id=setTimeout(WiFiPortal.Test.timeout,1e3*WiFiPortal.Test._timeout+2e3)},remove:function(){WiFiPortal.Timers.Timeout._id&&(clearTimeout(WiFiPortal.Timers.Timeout._id),WiFiPortal.Timers.Timeout._id=!1)}},Test:{_id:!1,init:function(){WiFiPortal.Timers.Test.remove(),WiFiPortal.Timers.Test._id=setTimeout(WiFiPortal.Test.check,1e3*WiFiPortal.Test._interval)},remove:function(){WiFiPortal.Timers.Test._id&&(clearTimeout(WiFiPortal.Timers.Test._id),WiFiPortal.Timers.Test._id=!1)}}},Buttons:{_proto:function(t,e){t=document.getElementById(t);return t&&t.addEventListener("click",e),{$el:t,preVal:!1,update:function(t){this.$el.innerHTML=t},disable:function(t){this.preVal||(this.preVal=this.$el.innerHTML),this.update(t),this.$el.disabled=!0},enable:function(){this.preVal&&(this.$el.innerHTML=this.preVal,this.preVal=!1),this.$el.disabled=!1}}},_all:{},_ids:["rescan","save","check"],init:function(){for(var t=0;t<WiFiPortal.Buttons._ids.length;t++){var e=WiFiPortal.Buttons._ids[t];WiFiPortal.Buttons._all[e]=new WiFiPortal.Buttons._proto(e,WiFiPortal[e])}},enableAll:function(){for(var t in WiFiPortal.Buttons._all)WiFiPortal.Buttons._all[t].enable()},disableAll:function(t){for(var e in WiFiPortal.Buttons._all)WiFiPortal.Buttons._all[e].disable(t)}},Test:{_timeout:30,_checks:0,_interval:5,success:!1,timedout:!1,ssid:!1,init:function(){WiFiPortal.Test._checks=0,WiFiPortal.Test.success=!1,WiFiPortal.Test.timedout=!1,setTimeout(WiFiPortal.Test.check,900),WiFiPortal.Timers.Timeout.init()},timeout:function(){var t;WiFiPortal.Test.success||(WiFiPortal.Test.timedout=!0,WiFiPortal.Error.show("Test has timed out after "+WiFiPortal.Test._timeout+" seconds. Please check the SSID and Password and try again."),WiFiPortal.Info.hide(),(t=document.getElementById("response"))&&(t.innerHTML="")),WiFiPortal.Timers.clear(),WiFiPortal.Buttons.enableAll()},check:function(){WiFiPortal.check(function(t){var e,i="Error";t&&!0!==t?t.wifi?(e=JSON.stringify(t.wifi,void 0,2),document.getElementById("response").innerHTML=WiFiPortal.highlight(e),t.wifi.status&&t.wifi.ssid&&("got ip"===t.wifi.status&&t.wifi.ssid===WiFiPortal.Test.ssid?(WiFiPortal.Test.success=!0,WiFiPortal.Error.hide(),WiFiPortal.Info.show("WiFi connection successful! Connected to "+t.wifi.ssid),WiFiPortal.Buttons.enableAll(),WiFiPortal.Timers.clear()):i="WiFi current status is "+t.wifi.status)):i="Received response, error getting WiFi status":(WiFiPortal.Info.hide(),WiFiPortal.Error.show("Error getting WiFi status, trying again in 5 seconds...")),WiFiPortal.Test._checks++,WiFiPortal.Test.success||WiFiPortal.Test.timedout||(WiFiPortal.Error.hide(),WiFiPortal.Info.show(i+", check "+WiFiPortal.Test._checks+", trying again in "+WiFiPortal.Test._interval+" seconds..."),WiFiPortal.Timers.Test.init())},"Checking device WiFi status...")}},save:function(){var t=document.getElementById("networks").value,e=document.getElementById("password").value,i=document.getElementById("puser").value;!t||t.length<1?(WiFiPortal.Info.hide(),WiFiPortal.Error.show("You must select an SSID from the dropdown!")):(WiFiPortal.Buttons.disableAll("Please wait, sending..."),WiFiPortal.Test.ssid=t,WiFiPortal.rpcCall("POST","WiFi.PortalTest","Sending credentials to device to test...",{ssid:t,pass:e,user:i},function(t){t&&!0!==t&&void 0!==t.result?!1===t.result?(WiFiPortal.Error.show("Error from device setting up STA! Check SSID and Password and try again!"),WiFiPortal.Buttons.enableAll()):(WiFiPortal.Error.hide(),WiFiPortal.Info.show("Device is testing WiFi connection, please wait..."),WiFiPortal.Test.init()):(WiFiPortal.Error.show("Error sending credentials to device, please try again"),WiFiPortal.Buttons.enableAll()),document.body.scrollTop=document.documentElement.scrollTop=0}))},rescan:function(){WiFiPortal.Buttons.disableAll("Scanning..."),WiFiPortal.rpcCall("POST","WiFi.PortalScan","Scanning for WiFi networks in range of device...",!1,function(t){var r;t&&0<t.length?(WiFiPortal.SSIDs=[],WiFiPortal.Networks=[],(r=document.getElementById("networks")).removeAttribute("disabled"),r.innerHTML='<option value="-1" disabled="disabled" selected="selected">Please select an SSID...</option>',t.forEach(function(t){var e,i,o;-1<WiFiPortal.SSIDs.indexOf(t.ssid)||(e=document.createElement("option"),o="OPEN",1===(i=parseInt(t.auth))?o="WEP":2===i?o="WPA/PSK":3===i?o="WPA2/PSK":4===i?o="WPA/WPA2/PSK":5===i&&(o="WPA2/ENT"),e.innerHTML=(0<i?"ðŸ”’ ":"ðŸ”“ ")+WiFiPortal.rssiToStrength(t.rssi)+"% - "+t.ssid+" ("+o+")",e.value=t.ssid,r.appendChild(e),WiFiPortal.SSIDs.push(t.ssid),WiFiPortal.Networks.push(t))}),WiFiPortal.Info.show("Please select from one of the "+WiFiPortal.SSIDs.length+" WiFi networks found.")):(WiFiPortal.Info.hide(),WiFiPortal.Error.show("No networks found, try again...")),WiFiPortal.Buttons.enableAll()})},rpcCall:function(t,e,i,o,r){if(!(httpRequest=new XMLHttpRequest))return WiFiPortal.Error.show("Unable to create an XMLHttpRequest, try to manually set"),r(!1);void 0!==i&&i&&WiFiPortal.Info.show(i),httpRequest.onreadystatechange=function(){if(httpRequest.readyState!==XMLHttpRequest.DONE)return!1;var t;200!==httpRequest.status?httpRequest.responseText&&0<httpRequest.responseText.length?(WiFiPortal.Error.show("Error from device ( "+httpRequest.responseText+" ) -- Please try again"),r(!0)):r(!1):(t=JSON.parse(httpRequest.responseText),r(t))},httpRequest.open(t,"/rpc/"+e),httpRequest.setRequestHeader("Content-Type","application/json"),httpRequest.send(JSON.stringify(o))},rssiToStrength:function(t){return quality=0===t||t<=-100?0:-50<=t?100:2*(t+100)},highlight:function(t){return(t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(t){var e="number";return/^"/.test(t)?e=/:$/.test(t)?"key":"string":/true|false/.test(t)?e="boolean":/null/.test(t)&&(e="null"),'<span class="'+e+'">'+t+"</span>"})},selectNetwork:function(e){var i=document.getElementById("passwrap"),o=document.getElementById("peapuserwrap"),r=(document.getElementById("networks"),!(o.style.display="none"));WiFiPortal.Networks.forEach(function(t){if(t.ssid===e)return 0===(t=parseInt(t.auth))?i.style.display="none":5===t?(i.style.display="block",o.style.display="block"):i.style.display="block",!(r=!0)}),r||(i.style.display="block")}};document.addEventListener("DOMContentLoaded",WiFiPortal.init);